<?xml version="1.0" encoding="UTF-8"?>

<?include Version.wxi ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="$(var.ProductGuid)" UpgradeCode="$(var.UpgradeCode)"
   Name="$(var.ProductLongName)" Version="$(var.ProductVersion)"
   Language="1033" Manufacturer="$(var.Manufacturer)">

    <Package Id="*" Compressed="yes"
     Description="$(var.ProductName) $(var.ProductVersionText) for .NET Framework v4.0 installation package)"
     InstallerVersion="200" ShortNames="no" Manufacturer="$(var.Manufacturer)" Languages="1033" SummaryCodepage="1252" />

    <MajorUpgrade DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

    <Condition Message="An administrator must approve or install [ProductName].">
      Privileged
    </Condition>

    <!-- Media -->
    <Media Id="1" Cabinet="Nemerle.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- Icons -->
    <Icon Id="NemerleIcon" SourceFile="../resources/Nemerle.ico" />

    <!-- Properties -->
    <Property Id="ARPPRODUCTICON"   Value="NemerleIcon" /> 
    <Property Id="ARPHELPLINK"      Value="http://Nemerle.org/" />
    <Property Id="ARPURLINFOABOUT"  Value="http://Nemerle.org/" />
    <Property Id="ARPURLUPDATEINFO" Value="http://Nemerle.org/" />

    <Property Id="UNINSTALLARGS" Value="/X{$(var.ProductGuid)}" />
    <Property Id="UNINSTALLCMD" Value="MSIEXEC.EXE" />
    <PropertyRef Id="VS2010DEVENV" />

    <WixVariable Id="WixUILicenseRtf" Value="../../../../License.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="../resources/bannrbmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="../resources/dlgbmp.bmp" />

    <!-- Root directories -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuDir" Name="$(var.ProductLongName)">
          <Component Id="RemoveProgramMenuDir" Guid="3c1d32c6-d1a0-4e46-bbe4-0db3033a8ee3">
            <RegistryKey Root="HKCU" Key="Software\$(var.ProductName)\net-4.0\InstallDir">
              <RegistryValue Value="[APPLICATIONFOLDER]" Type="string" KeyPath="yes" />
            </RegistryKey> 
            <Shortcut Id="InvokeRemove" Name="Uninstall $(var.ProductName)" Target="[UNINSTALLCMD]" Arguments="[UNINSTALLARGS]" WorkingDirectory="SystemDir" Directory="ProgramMenuDir" Description="Uninstall" />
            <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
          </Component>
        </Directory>
      </Directory>
      <Directory Id="ProgramFilesFolder" Name="PFILES">
        <Directory Id="ROOTAPPLICATIONFOLDER" Name="$(var.ProductName)">
          <Directory Id="APPLICATIONFOLDER" Name="net-4.0">
            <Directory Id="Dir_Docs" Name="docs" />
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Root feature -->
    <Feature Id="Feature_Root" Title="Nemerle" Description="Complete installation." AllowAdvertise="no" Display="expand" InstallDefault="local" Level="1" Absent="disallow">
      <ComponentRef Id="RemoveProgramMenuDir" />
      <ComponentGroupRef Id="CompGroup_NemerleRuntime" />

      <Feature Id="Feature_Compiler" Title="Compiler and tools" Description="Nemerle Compiler (ncc.exe) and additional tools." AllowAdvertise="no" Level="1">
        <ComponentGroupRef Id="CompGroup_NemerleBinaries" />
      </Feature>

      <Feature Id="Feature_PowerPack" Title="Power Pack!" Description="Additional macro libraries: parser generator, computation expressions macros. C# source support for Nemerle compiler." AllowAdvertise="no" Level="1">
        <ComponentGroupRef Id="CompGroup_PowerPack" />
      </Feature>

      <Feature Id="Feature_Docs" Title="Documentation" Description="HTML and PDF files." Level="1">
        <ComponentGroupRef Id="CompGroup_Documentation" />
      </Feature>

      <Feature Id="Feature_VS2010" Title="Visual Studio 2010 Integration" Description="Nemerle Project and IntelliSense for Visual Studio 2010" AllowAdvertise="no" Display="expand" InstallDefault="local" Level="0" TypicalDefault="install">
          <Condition Level="1">VS2010DEVENV</Condition>
          <ComponentGroupRef Id="CompGroup_VS2010Extension" />
      </Feature>

    </Feature>

        <CustomAction Id="CA_SetJunction" FileKey="File_Junction" ExeCommand='[APPLICATIONROOTFOLDER]' Execute="deferred" Impersonate="no" />

        <!-- Install Sequences -->
        <InstallExecuteSequence>
            <FindRelatedProducts Before="LaunchConditions" />
            <Custom Action="CA_SetJunction" Before="InstallFinalize">NOT Installed</Custom> 
         </InstallExecuteSequence>

        <InstallUISequence>
            <FindRelatedProducts Before="LaunchConditions" />
        </InstallUISequence>

        <!-- WixUI_Advanced scaffolding (to be replaced by extension authoring) -->
        <Property Id="ApplicationFolderName" Value="$(var.ProductShortName)\net-4.0\" />
        <Property Id="ALLUSERS" Value="1" />
        <Property Id="WixAppFolder" Value="WixPerMachineFolder" />

        <WixVariable Id="WixUISupportPerMachine" Value="1" />
        <WixVariable Id="WixUISupportPerUser" Value="0" />

        <UI>
            <UIRef Id="WixUI_Advanced" />
            <UIRef Id="WixUI_ErrorProgressText" />
        </UI>
    </Product>
</Wix>