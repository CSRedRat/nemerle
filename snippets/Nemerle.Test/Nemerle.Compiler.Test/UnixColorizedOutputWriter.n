using Nemerle;
using Nemerle.Assertions;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;

namespace Nemerle.Compiler.Test
{
  /// <summary>
  /// Description of UnixColorizedOutputWriter.
  /// </summary>
  internal sealed class UnixColorizedOutputWriter : ColorizedOutputWriter
  {
    public this([NotNull] output : TextWriter)
    {
      _output = output;
    }

    public override Write(color : ConsoleColor?, text : string) : void
    {
      if(color.HasValue)
      {
        def colored = beginColor(color.GetValueOrDefault());
        try _output.Write(text);
        finally when(colored) endColor();
      }
      else _output.Write(text);
    }

    public override WriteLine(color : ConsoleColor?, text : string) : void
    {
      if(color.HasValue)
      {
        def colored = beginColor(color.GetValueOrDefault());
        try _output.WriteLine(text);
        finally when(colored) endColor();
      }
      else _output.WriteLine(text);
    }

    private beginColor(color : ConsoleColor) : bool
    {
      | Green  with value = "\e[01;32m"
      | Yellow with value = "\e[01;33m"
      | Red    with value = "\e[01;31m"
      | Cyan   with value = "\e[01;36m" => _output.Write(value); true
      | _ => false
    }

    private endColor() : void
    {
      _output.Write("\e[0m");
    }

    private _output : TextWriter;
  }
}
